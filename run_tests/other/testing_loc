#! /usr/bin/env bash

# $Header: /u/gcmpack/MITgcm_contrib/test_scripts/other/testing_loc,v 1.3 2011/07/11 22:58:30 jmc Exp $
# $Name:  $

#echo 'source ~jmc/bin/intel_v11.sh'
#source ~jmc/bin/intel_v11.sh
 echo 'source ~jmc/bin/intel_v12.sh'
 source ~jmc/bin/intel_v12.sh
tst_list='mp2 ur4'
#tst_list='ur4'
#tst_list='mp2'

for tt in $tst_list
do

  echo "=========================================================================="
  set -x
  rm -f tr_clean_$tt.log
  #- cleanup previous restart:
  ( cd MITgcm_$tt/verification ; ../tools/do_tst_2+2 -clean > ../../tr_clean_$tt.log 2>&1 )
  #- cleanup previous test:
  ( cd MITgcm_$tt/verification ; testreport -clean >> ../../tr_clean_$tt.log 2>&1 )

  set +x
  echo ""

  echo "=========================================================================="
  set -x
  ( cd MITgcm_$tt ; cvs update -P -d  >> ../tr_clean_$tt.log 2>&1 )
  set +x
  echo ""

  echo "=========================================================================="

  mv -f tr_run_$tt.log tr_run_$tt.log_bak
  cd MITgcm_$tt/verification

  date
  # verbose mode:
  set -x
  pwd

if test $tt = 'mp2' ; then

  export OMP_NUM_THREADS=2
  export KMP_STACKSIZE=400m

  testreport -MPI 2 -mth -of ../tools/build_options/linux_amd64_ifort11+mpi_generic \
   -devel -command='mpirun -v -np TR_NPROC ./mitgcmuv' \
   -a jmc@mitgcm.org -nc > ../../tr_run_$tt.log 2>&1

  #unset echo
  sed -n "/ email /,$ p" ../../tr_run_$tt.log

  #- test restart:
  echo '' >> ../../tr_run_$tt.log 2>&1
  ../tools/do_tst_2+2 -mpi -exe 'mpirun -v -np TR_NPROC ./mitgcmuv' \
   -a jmc@mitgcm.org >> ../../tr_run_$tt.log 2>&1

fi

if test $tt = 'ur4' ; then

  testreport -MPI 3 -ur4 -of ../tools/build_options/linux_amd64_ifort11+mpi_generic \
   -devel -nc -ef -syntax-only -obj -dd > ../../tr_run_$tt.log 2>&1

  testreport -MPI 3 -ur4 -of ../tools/build_options/linux_amd64_ifort11+mpi_generic \
   -devel -nc -match 5 -command='mpirun -v -np TR_NPROC ./mitgcmuv' \
   -a jmc@mitgcm.org >> ../../tr_run_$tt.log 2>&1

  sed -n "/ email /,$ p" ../../tr_run_$tt.log

  #- test restart:
  echo '' >> ../../tr_run_$tt.log 2>&1
  ../tools/do_tst_2+2 -mpi -exe 'mpirun -v -np TR_NPROC ./mitgcmuv' \
   -a jmc@mitgcm.org >> ../../tr_run_$tt.log 2>&1

fi

  set +x
  cd ../..

done
