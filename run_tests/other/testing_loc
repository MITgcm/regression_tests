#! /usr/bin/env bash

# $Header: /u/gcmpack/MITgcm_contrib/test_scripts/other/testing_loc,v 1.17 2013/09/23 15:32:48 jmc Exp $
# $Name:  $

if test $# = 0 ; then
  echo 'need 1 argument'
  exit
else
  if test $1 = ifort ; then
#   tst_list='iadm imp2 iur4'
    tst_list='iad4 imp2 iur4'
  elif test $1 = gfort ; then
#   tst_list='gadm gads gmp2 gmpi gfo g77'
    tst_list='gadm gads gmp2 gfo'
  elif test $1 = gfor4 ; then
    tst_list='gad4 gmp4 gfo4 g77'
  else
    tst_list=$*
  fi
fi
  echo "run: \""`basename $0` $*"\" on:" `date`
  echo " tst_list='$tst_list'"

#-- for now, cannot mix ifort/gfortran tests:
gfort=1
for tt in $tst_list
do
  echo $tt | grep '^g' > /dev/null 2>&1 ; retv=$?
  if   [ $retv -eq 0 -a $gfort -ge 1 ] ; then gfort=2
  elif [ $retv -ne 0 -a $gfort -le 1 ] ; then gfort=0
  else echo 'cannot mix ifort/gfortran' ; exit
  fi
done
if [ $gfort -eq 0 ] ; then
  #echo 'source ~jmc/bin/intel_v12.sh'
  #source ~jmc/bin/intel_v12.sh
   echo 'source ~jmc/bin/intel_v14.sh'
   source ~jmc/bin/intel_v14.sh
fi
if [ $gfort -eq 2 ] ; then
   echo 'source ~jmc/bin/openmpi.sh'
   source ~jmc/bin/openmpi.sh
fi

#--------------------------------------------------------------------
for tt in $tst_list
do

  echo "=========================================================================="
# set -x
  rm -f tr_clean_$tt.log
  echo $tt | grep '^.ad' > /dev/null 2>&1 ; fwd=$?
  echo " testing tt= $tt , fwd= $fwd"
if [ $fwd -eq 0 ] ; then
  set -x
  ( cd MITgcm_$tt/verification ; testreport -adm -clean > ../../tr_clean_$tt.log 2>&1 )
  set +x
else
  set -x
  #- cleanup previous restart:
  ( cd MITgcm_$tt/verification ; ../tools/do_tst_2+2 -clean > ../../tr_clean_$tt.log 2>&1 )
  #- cleanup previous test:
  ( cd MITgcm_$tt/verification ; testreport -clean >> ../../tr_clean_$tt.log 2>&1 )
  set +x
fi
  if [ $gfort -eq 0 ] ; then
    echo ' remove all Makefile_syntax and do "cvs update -P -d"' >> tr_clean_$tt.log
    ( cd MITgcm_$tt/verification ; rm -f */build/Makefile_syntax )
  else
    echo ' run "cvs update -P -d"'  >> tr_clean_$tt.log
  fi
  echo ""

  echo "=========================================================================="
  set -x
  ( cd MITgcm_$tt ; cvs update -P -d  >> ../tr_clean_$tt.log 2>&1 )
  set +x
  echo ""

  echo "=========================================================================="

  if test -e tr_run_$tt.log ; then mv -f tr_run_$tt.log tr_run_$tt.log_bak ; fi
  cd MITgcm_$tt/verification

  date
  # verbose mode:
  set -x
  pwd

case $tt in
'iadm' )
  if test -e tr_out.txt ; then /bin/rm -f tr_out.sav ; mv tr_out.txt tr_out.sav ; fi

  testreport -MPI 3 -adm -of ../tools/build_options/linux_amd64_ifort11 \
   -devel -nc -repl_mk do_make_syntax.sh -obj -dd > ../../tr_run_$tt.log 2>&1
  echo '' >> ../../tr_run_$tt.log 2>&1

  testreport -MPI 3 -adm -of ../tools/build_options/linux_amd64_ifort11 \
   -devel -q -a jmc@mitgcm.org >> ../../tr_run_$tt.log 2>&1

  sed -n "/ email /,/^======== End of testreport / p" ../../tr_run_$tt.log
;;

'iad4' )
  if test -e tr_out.txt ; then /bin/rm -f tr_out.sav ; mv tr_out.txt tr_out.sav ; fi

  testreport -MPI 3 -ur4 -adm -of ../tools/build_options/linux_amd64_ifort11 \
   -devel -nc -repl_mk do_make_syntax.sh -obj -dd > ../../tr_run_$tt.log 2>&1
  echo '' >> ../../tr_run_$tt.log 2>&1

  testreport -MPI 3 -ur4 -adm -of ../tools/build_options/linux_amd64_ifort11 \
   -devel -q -match 5 -a jmc@mitgcm.org >> ../../tr_run_$tt.log 2>&1

  sed -n "/ email /,/^======== End of testreport / p" ../../tr_run_$tt.log
;;

'imp2')
  if test -e tr_out.txt ; then /bin/rm -f tr_out.sav ; mv tr_out.txt tr_out.sav ; fi

  export OMP_NUM_THREADS=2
  export KMP_STACKSIZE=400m

  testreport -MPI 2 -mth -of ../tools/build_options/linux_amd64_ifort11 \
   -devel -nc -repl_mk do_make_syntax.sh -obj -dd > ../../tr_run_$tt.log 2>&1
  echo '' >> ../../tr_run_$tt.log 2>&1

  testreport -MPI 2 -mth -of ../tools/build_options/linux_amd64_ifort11 \
   -devel -q -a jmc@mitgcm.org >> ../../tr_run_$tt.log 2>&1

  sed -n "/ email /,/^======== End of testreport / p" ../../tr_run_$tt.log

  #- test restart:
  echo '' >> ../../tr_run_$tt.log 2>&1
  ../tools/do_tst_2+2 -mpi -a jmc@mitgcm.org >> ../../tr_run_$tt.log 2>&1
;;

'iur4')
  if test -e tr_out.txt ; then /bin/rm -f tr_out.sav ; mv tr_out.txt tr_out.sav ; fi

  testreport -MPI 3 -ur4 -of ../tools/build_options/linux_amd64_ifort11 \
   -devel -nc -repl_mk do_make_syntax.sh -obj -dd > ../../tr_run_$tt.log 2>&1
  echo '' >> ../../tr_run_$tt.log 2>&1

  testreport -MPI 3 -ur4 -of ../tools/build_options/linux_amd64_ifort11 \
   -devel -q -match 5 -a jmc@mitgcm.org >> ../../tr_run_$tt.log 2>&1

  sed -n "/ email /,/^======== End of testreport / p" ../../tr_run_$tt.log

  #- test restart:
  echo '' >> ../../tr_run_$tt.log 2>&1
  ../tools/do_tst_2+2 -mpi -a jmc@mitgcm.org >> ../../tr_run_$tt.log 2>&1
;;

'gadm')
  if test -e tr_out.txt ; then /bin/rm -f tr_out.sav ; mv tr_out.txt tr_out.sav ; fi

  testreport -MPI 3 -adm -of ../tools/build_options/linux_amd64_gfortran \
   -devel -nc -a jmc@mitgcm.org >> ../../tr_run_$tt.log 2>&1

  sed -n "/ email /,/^======== End of testreport / p" ../../tr_run_$tt.log
;;

'gads')
  if test -e tr_out.txt ; then /bin/rm -f tr_out.sav ; mv tr_out.txt tr_out.sav ; fi

  testreport -adm -of ../tools/build_options/linux_amd64_gfortran \
   -devel -nc -a jmc@mitgcm.org >> ../../tr_run_$tt.log 2>&1

  sed -n "/ email /,/^======== End of testreport / p" ../../tr_run_$tt.log
;;

'gad4')
  if test -e tr_out.txt ; then /bin/rm -f tr_out.sav ; mv tr_out.txt tr_out.sav ; fi

  testreport -adm -ur4 -of ../tools/build_options/linux_amd64_gfortran \
   -devel -nc -match 5 -a jmc@mitgcm.org >> ../../tr_run_$tt.log 2>&1

  sed -n "/ email /,/^======== End of testreport / p" ../../tr_run_$tt.log
;;

'gmp2')
  if test -e tr_out.txt ; then /bin/rm -f tr_out.sav ; mv tr_out.txt tr_out.sav ; fi

  export OMP_NUM_THREADS=2
  export GOMP_STACKSIZE=400m

  testreport -MPI 2 -mth -of ../tools/build_options/linux_amd64_gfortran \
   -devel -nc -a jmc@mitgcm.org >> ../../tr_run_$tt.log 2>&1

  sed -n "/ email /,/^======== End of testreport / p" ../../tr_run_$tt.log

  #- test restart:
  echo '' >> ../../tr_run_$tt.log 2>&1
  ../tools/do_tst_2+2 -mpi -a jmc@mitgcm.org >> ../../tr_run_$tt.log 2>&1
;;

'gmpi')
  if test -e tr_out.txt ; then /bin/rm -f tr_out.sav ; mv tr_out.txt tr_out.sav ; fi

  testreport -MPI 3 -of ../tools/build_options/linux_amd64_gfortran \
   -devel -nc -a jmc@mitgcm.org >> ../../tr_run_$tt.log 2>&1

  sed -n "/ email /,/^======== End of testreport / p" ../../tr_run_$tt.log

  #- test restart:
  echo '' >> ../../tr_run_$tt.log 2>&1
  ../tools/do_tst_2+2 -mpi -a jmc@mitgcm.org >> ../../tr_run_$tt.log 2>&1
;;

'gmp4')
  if test -e tr_out.txt ; then /bin/rm -f tr_out.sav ; mv tr_out.txt tr_out.sav ; fi

  testreport -MPI 3 -ur4 -of ../tools/build_options/linux_amd64_gfortran \
   -devel -nc -match 5 -a jmc@mitgcm.org >> ../../tr_run_$tt.log 2>&1

  sed -n "/ email /,/^======== End of testreport / p" ../../tr_run_$tt.log

  #- test restart:
  echo '' >> ../../tr_run_$tt.log 2>&1
  ../tools/do_tst_2+2 -mpi -a jmc@mitgcm.org >> ../../tr_run_$tt.log 2>&1
;;

'gfo')
  if test -e tr_out.txt ; then /bin/rm -f tr_out.sav ; mv tr_out.txt tr_out.sav ; fi

  testreport -of ../tools/build_options/linux_amd64_gfortran \
   -devel -nc -a jmc@mitgcm.org >> ../../tr_run_$tt.log 2>&1

  sed -n "/ email /,/^======== End of testreport / p" ../../tr_run_$tt.log

  #- test restart:
  echo '' >> ../../tr_run_$tt.log 2>&1
  ../tools/do_tst_2+2 -a jmc@mitgcm.org >> ../../tr_run_$tt.log 2>&1
;;

'gfo4')
  if test -e tr_out.txt ; then /bin/rm -f tr_out.sav ; mv tr_out.txt tr_out.sav ; fi

  testreport -ur4 -of ../tools/build_options/linux_amd64_gfortran \
   -devel -nc -match 5 -a jmc@mitgcm.org >> ../../tr_run_$tt.log 2>&1

  sed -n "/ email /,/^======== End of testreport / p" ../../tr_run_$tt.log

  #- test restart:
  echo '' >> ../../tr_run_$tt.log 2>&1
  ../tools/do_tst_2+2 -a jmc@mitgcm.org >> ../../tr_run_$tt.log 2>&1
;;

'g77')
  if test -e tr_out.txt ; then /bin/rm -f tr_out.sav ; mv tr_out.txt tr_out.sav ; fi

  testreport -of ../tools/build_options/linux_amd64_g77 \
   -skd 'fizhi-cs-32x32x40 fizhi-cs-aqualev20' \
   -nc -a jmc@mitgcm.org >> ../../tr_run_$tt.log 2>&1

  sed -n "/ email /,/^======== End of testreport / p" ../../tr_run_$tt.log

  #- test restart:
  echo '' >> ../../tr_run_$tt.log 2>&1
  ../tools/do_tst_2+2 -a jmc@mitgcm.org >> ../../tr_run_$tt.log 2>&1
;;

*) echo "unrecognized test suffix '$tt' <== skipped" ;;
esac

  set +x
  cd ../..

done
